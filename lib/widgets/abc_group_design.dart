import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:intl/intl.dart';
import 'custom_appbar.dart';
import '../features/2nd_treatment/abc_group_add_screen.dart';

/// ü™∏ Mindrium ÏàòÏ°±Í¥Ä Ïä§ÌÉÄÏùº Í±±Ï†ï Í∑∏Î£π Î™©Î°ù (withOpacity Ï†úÍ±∞ Î≤ÑÏ†Ñ)
class AbcGroupListView extends StatelessWidget {
  final List<QueryDocumentSnapshot<Map<String, dynamic>>> docs;
  final Map<String, List<QueryDocumentSnapshot<Map<String, dynamic>>>>
  diariesByGroup;
  final String uid;
  final int selectedIndex;
  final ValueChanged<int> onSelect;
  final void Function(
    BuildContext,
    Map<String, dynamic>,
    DocumentReference<Map<String, dynamic>>,
  )
  onEdit;

  const AbcGroupListView({
    super.key,
    required this.docs,
    required this.diariesByGroup,
    required this.uid,
    required this.selectedIndex,
    required this.onSelect,
    required this.onEdit,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBodyBehindAppBar: true,
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          /// üåä Î∞∞Í≤Ω (eduhome + ÏàòÏã¨ Í∑∏ÎùºÎç∞Ïù¥ÏÖò)
          Container(
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  Color(0xFF004C73),
                  Color(0xFF78D5F5),
                  Color(0xFFAEE6FF),
                ],
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
              ),
            ),
          ),
          Image.asset(
            'assets/image/eduhome.png',
            fit: BoxFit.cover,
            color: const Color.fromRGBO(255, 255, 255, 0.35),
            colorBlendMode: BlendMode.srcOver,
          ),

          /// ‚ú® ÏÉÅÎã® ÎπõÍ∏∞Îë• Ìö®Í≥º
          IgnorePointer(
            child: Align(
              alignment: Alignment.topCenter,
              child: Container(
                height: 220,
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      Color.fromRGBO(255, 255, 255, 0.25),
                      Color.fromRGBO(255, 255, 255, 0.0),
                    ],
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                  ),
                ),
              ),
            ),
          ),

          /// ÏΩòÌÖêÏ∏†
          SafeArea(
            child: Column(
              children: [
                const CustomAppBar(title: 'Í±±Ï†ï Í∑∏Î£π Î™©Î°ù'),

                Expanded(
                  child: Padding(
                    padding: const EdgeInsets.fromLTRB(20, 24, 20, 16),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(28),
                      child: BackdropFilter(
                        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Container(
                          decoration: BoxDecoration(
                            color: const Color.fromRGBO(255, 255, 255, 0.25),
                            borderRadius: BorderRadius.circular(28),
                            border: Border.all(
                              color: const Color.fromRGBO(255, 255, 255, 0.4),
                              width: 1.2,
                            ),
                            boxShadow: const [
                              BoxShadow(
                                color: Color.fromRGBO(173, 216, 230, 0.25),
                                blurRadius: 20,
                                offset: Offset(0, 8),
                              ),
                            ],
                          ),
                          child: ListView.separated(
                            padding: const EdgeInsets.all(20),
                            itemCount: docs.length + 1,
                            separatorBuilder:
                                (_, __) => const SizedBox(height: 14),
                            itemBuilder: (ctx, i) {
                              if (i == 0) return const AddGroupCard();
                              final doc = docs[i - 1];
                              final data = doc.data();
                              final groupId =
                                  (data['group_id'] ?? '').toString();
                              final diaries = diariesByGroup[groupId] ?? [];
                              return GroupCard(
                                uid: uid,
                                group: data,
                                index: i,
                                docRef: doc.reference,
                                isSelected: selectedIndex == i,
                                diaryCount: diaries.length,
                                onSelect: () => onSelect(i),
                                onEdit: onEdit,
                              );
                            },
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

/// ü´ß Í∑∏Î£π Ï∂îÍ∞Ä Ïπ¥Îìú (ÌååÏä§ÌÖî Î∞©Ïö∏Ìòï Î≤ÑÌäº)
class AddGroupCard extends StatelessWidget {
  const AddGroupCard({super.key});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap:
          () => Navigator.push(
            context,
            MaterialPageRoute(builder: (_) => const AbcGroupAddScreen1()),
          ),
      child: Container(
        height: 56,
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [Color(0xFF8FDFFF), Color(0xFFC4F5FF)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(40),
          boxShadow: const [
            BoxShadow(
              color: Color.fromRGBO(173, 216, 230, 0.4),
              blurRadius: 12,
              offset: Offset(0, 4),
            ),
          ],
        ),
        child: const Center(
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.add_circle_outline,
                color: Color(0xFF0E4569),
                size: 22,
              ),
              SizedBox(width: 8),
              Text(
                'Í∑∏Î£π Ï∂îÍ∞Ä',
                style: TextStyle(
                  fontFamily: 'Noto Sans KR',
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                  color: Color(0xFF0E4569),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/// üêö Í∑∏Î£π Ïπ¥Îìú (Ïú†Î¶¨ ÎäêÎÇå + ÏÑ†ÌÉù Ïãú ÌïòÏù¥ÎùºÏù¥Ìä∏)
class GroupCard extends StatelessWidget {
  final String uid;
  final Map<String, dynamic> group;
  final int index;
  final DocumentReference<Map<String, dynamic>> docRef;
  final bool isSelected;
  final int diaryCount;
  final VoidCallback onSelect;
  final void Function(
    BuildContext,
    Map<String, dynamic>,
    DocumentReference<Map<String, dynamic>>,
  )
  onEdit;

  const GroupCard({
    super.key,
    required this.uid,
    required this.group,
    required this.index,
    required this.docRef,
    required this.isSelected,
    required this.diaryCount,
    required this.onSelect,
    required this.onEdit,
  });

  @override
  Widget build(BuildContext context) {
    final groupId = (group['group_id'] ?? '').toString();
    final title = (group['group_title'] ?? '').toString();
    final contents = (group['group_contents'] ?? '').toString();
    final createdAt =
        (group['createdAt'] is Timestamp)
            ? (group['createdAt'] as Timestamp).toDate()
            : DateTime.now();
    final createdStr = DateFormat('yyyy.MM.dd').format(createdAt);

    final Color highlightColor = const Color(0xFF007BA7);

    return GestureDetector(
      onTap: onSelect,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors:
                isSelected
                    ? [Color(0xFFD0F2FF), Color(0xFFB9E8FF)]
                    : [
                      Color.fromRGBO(255, 255, 255, 0.6),
                      Color.fromRGBO(255, 255, 255, 0.4),
                    ],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(18),
          border: Border.all(
            color:
                isSelected
                    ? highlightColor
                    : const Color.fromRGBO(255, 255, 255, 0.4),
            width: isSelected ? 2 : 1,
          ),
          boxShadow: [
            BoxShadow(
              color:
                  isSelected
                      ? const Color.fromRGBO(0, 123, 167, 0.4)
                      : const Color.fromRGBO(0, 0, 0, 0.1),
              blurRadius: 10,
              offset: const Offset(0, 6),
            ),
          ],
        ),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.center,
          children: [
            CircleAvatar(
              radius: 28,
              backgroundColor: const Color.fromRGBO(255, 255, 255, 0.6),
              child: ClipOval(
                child: Image.asset(
                  'assets/image/character$groupId.png',
                  width: 56,
                  height: 56,
                  fit: BoxFit.cover,
                  errorBuilder:
                      (_, __, ___) => const Icon(
                        Icons.folder,
                        size: 30,
                        color: Colors.grey,
                      ),
                ),
              ),
            ),
            const SizedBox(width: 14),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title.isNotEmpty ? title : 'Ï†úÎ™© ÏóÜÏùå',
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: TextStyle(
                      fontFamily: 'Noto Sans KR',
                      fontWeight: FontWeight.w700,
                      fontSize: 16,
                      color:
                          isSelected ? highlightColor : const Color(0xFF103050),
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    contents.isNotEmpty ? contents : 'ÎÇ¥Ïö© ÏóÜÏùå',
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                    style: const TextStyle(
                      fontFamily: 'Noto Sans KR',
                      fontSize: 14,
                      color: Color(0xFF102030),
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    'ÏûëÏÑ±Ïùº: $createdStr',
                    style: const TextStyle(
                      fontFamily: 'Noto Sans KR',
                      fontSize: 12,
                      color: Color(0xAA102030),
                    ),
                  ),
                ],
              ),
            ),
            if (groupId != '1')
              IconButton(
                icon: Icon(
                  Icons.edit,
                  size: 22,
                  color: isSelected ? highlightColor : const Color(0xFF004C73),
                ),
                onPressed: () => onEdit(context, group, docRef),
              ),
          ],
        ),
      ),
    );
  }
}

/// ‚ú® Í∑∏Î£π ÏàòÏ†ï Î∞îÌÖÄÏãúÌä∏ (ÌïòÎäòÎπõ ÌåùÏóÖ)
class EditGroupBottomSheet extends StatelessWidget {
  final TextEditingController titleController;
  final TextEditingController contentsController;
  final VoidCallback onSave;

  const EditGroupBottomSheet({
    super.key,
    required this.titleController,
    required this.contentsController,
    required this.onSave,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          colors: [Color(0xFFE9F8FF), Color(0xFFBFEAFF)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        boxShadow: [
          BoxShadow(
            color: Color.fromRGBO(173, 216, 230, 0.3),
            blurRadius: 20,
            offset: Offset(0, -4),
          ),
        ],
      ),
      padding: const EdgeInsets.all(20),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          const Text(
            'Í∑∏Î£π Ìé∏Ïßë',
            style: TextStyle(
              fontFamily: 'Noto Sans KR',
              fontWeight: FontWeight.w700,
              fontSize: 18,
              color: Color(0xFF003A64),
            ),
          ),
          const SizedBox(height: 16),
          TextField(
            controller: titleController,
            decoration: InputDecoration(
              labelText: 'Ï†úÎ™©',
              labelStyle: const TextStyle(color: Color(0xFF004C73)),
              filled: true,
              fillColor: const Color.fromRGBO(255, 255, 255, 0.7),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          ),
          const SizedBox(height: 12),
          TextField(
            controller: contentsController,
            maxLines: 3,
            decoration: InputDecoration(
              labelText: 'ÏÑ§Î™Ö',
              labelStyle: const TextStyle(color: Color(0xFF004C73)),
              filled: true,
              fillColor: const Color.fromRGBO(255, 255, 255, 0.7),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          ),
          const SizedBox(height: 16),
          ElevatedButton.icon(
            onPressed: onSave,
            icon: const Icon(Icons.save),
            label: const Text('ÏàòÏ†ï'),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF007BA7),
              foregroundColor: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(14),
              ),
              elevation: 3,
            ),
          ),
        ],
      ),
    );
  }
}

/// ü´ß Mindrium ÌïòÎäòÎπõ Î°úÎî© ÌôîÎ©¥
class AbcGroupLoading extends StatelessWidget {
  const AbcGroupLoading({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBodyBehindAppBar: true,
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          /// üåä ÏàòÏã¨ Í∑∏ÎùºÎç∞Ïù¥ÏÖò + eduhome Î∞∞Í≤Ω
          Container(
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  Color(0xFF004C73),
                  Color(0xFF78D5F5),
                  Color(0xFFAEE6FF),
                ],
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
              ),
            ),
          ),
          Image.asset(
            'assets/image/eduhome.png',
            fit: BoxFit.cover,
            color: const Color.fromRGBO(255, 255, 255, 0.35),
            colorBlendMode: BlendMode.srcOver,
          ),

          /// ‚ú® ÏÉÅÎã® ÎπõÍ∏∞Îë• Ìö®Í≥º
          IgnorePointer(
            child: Align(
              alignment: Alignment.topCenter,
              child: Container(
                height: 220,
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      Color.fromRGBO(255, 255, 255, 0.25),
                      Color.fromRGBO(255, 255, 255, 0.0),
                    ],
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                  ),
                ),
              ),
            ),
          ),

          /// Î°úÎî© ÎÇ¥Ïö©
          const SafeArea(
            child: Column(
              children: [
                CustomAppBar(title: 'Í±±Ï†ï Í∑∏Î£π Î™©Î°ù'),
                Expanded(
                  child: Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        CircularProgressIndicator(
                          strokeWidth: 3.5,
                          color: Color(0xFF007BA7),
                        ),
                        SizedBox(height: 16),
                        Text(
                          'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏù¥ÏóêÏöî...',
                          style: TextStyle(
                            fontFamily: 'Noto Sans KR',
                            fontSize: 15,
                            fontWeight: FontWeight.w500,
                            color: Color(0xFF003A64),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
